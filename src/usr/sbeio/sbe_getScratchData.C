/* IBM_PROLOG_BEGIN_TAG                                                   */
/* This is an automatically generated prolog.                             */
/*                                                                        */
/* $Source: src/usr/sbeio/sbe_getScratchData.C $                          */
/*                                                                        */
/* OpenPOWER HostBoot Project                                             */
/*                                                                        */
/* Contributors Listed Below - COPYRIGHT 2023                             */
/* [+] International Business Machines Corp.                              */
/*                                                                        */
/*                                                                        */
/* Licensed under the Apache License, Version 2.0 (the "License");        */
/* you may not use this file except in compliance with the License.       */
/* You may obtain a copy of the License at                                */
/*                                                                        */
/*     http://www.apache.org/licenses/LICENSE-2.0                         */
/*                                                                        */
/* Unless required by applicable law or agreed to in writing, software    */
/* distributed under the License is distributed on an "AS IS" BASIS,      */
/* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or        */
/* implied. See the License for the specific language governing           */
/* permissions and limitations under the License.                         */
/*                                                                        */
/* IBM_PROLOG_END_TAG                                                     */

/**
  * @file  sbe_getScratchData.C
  * @brief Contains the get SBE Scratch Data chipop for SBE FIFO
  *
  */

#include "sbe_fifodd.H"

#include <sbeio/sbeioif.H>
#include <sbeio/sbe_utils.H>
#include <sbeio/sbeioreasoncodes.H>
#include "sbe_fifo_buffer.H"

#include <errl/errlmanager.H>
#include <targeting/common/targetservice.H>
#include <trace/interface.H>

extern trace_desc_t* g_trac_sbeio;

#define SBE_TRACD(printf_string,args...) \
    TRACDCOMP(g_trac_sbeio,"GenericMsg: " printf_string,##args)

#define SBE_TRACF(printf_string,args...) \
    TRACFCOMP(g_trac_sbeio,"GenericMsg: " printf_string,##args)

using namespace TARGETING;

namespace SBEIO
{
    /**
     * @brief Retrieves data stored in the SBE Scratch area. Due to tight memory constraints, the SBE scratch area will
     *        always be cleared on successful execution of this command. The data in the scratch area is typically
     *        generated by hardware procedures running on the SBE.
     *
     * @param[in] i_chipTarget The chip you would like to perform the chipop on
     *                       NOTE: HB should only be sending this to Odyssey chips
     * @param[out]    o_pFifoResponse Pointer to response
     *
     * @return errlHndl_t Error log handle on failure.
     *
     */
    errlHndl_t sendGetScratchDataRequest(TARGETING::Target      * i_chipTarget,
                                         sbeScratchDataResponse_t & o_pFifoResponse)
    {
        errlHndl_t errl = nullptr;

        do
        {
            // Make sure the target is one of the supported types.
            errl = sbeioInterfaceChecks(i_chipTarget,
                                        SbeFifo::SBE_FIFO_CLASS_GENERIC_MESSAGE,
                                        SbeFifo::SBE_FIFO_CMD_GET_SCRATCH_DATA);
            if(errl)
            {
                break;
            }
            // Only support OCMB targets. Interface checks above already verified this is an odyssey chip.
            errl = sbeioOdysseyCheck(i_chipTarget,
                                     SbeFifo::SBE_FIFO_CLASS_GENERIC_MESSAGE,
                                     SbeFifo::SBE_FIFO_CMD_GET_SCRATCH_DATA);
            if(errl)
            {
                break;
            }

            SbeFifo::fifoGetSbeScratchDataRequest l_fifoRequest;

            // The response from the chip-op is larger than Hostboot's stack size so the buffer needs to be allocated on
            // the heap. To ease the caller's responsibility we allocate a shared_ptr of the correct size and return it
            // to the caller.
            o_pFifoResponse = std::make_shared<std::array<uint32_t, MAX_SBE_SCRATCH_DATA_WORDS>>();
            static_assert(MAX_SBE_SCRATCH_DATA_WORDS < SbeFifoRespBuffer::MSG_BUFFER_SIZE_WORDS,
                          "Not enough space return all SBE scratch data");
            static_assert((MAX_SBE_SCRATCH_DATA_WORDS * sizeof(uint32_t)) == (64 * KILOBYTE),
                          "Expected MAX_SBE_SCRATCH_DATA_WORDS to be 64k, consider current design.");
            errl = SbeFifo::getTheInstance().performFifoChipOp(i_chipTarget,
                                                               reinterpret_cast<uint32_t *>(&l_fifoRequest),
                                                               &(o_pFifoResponse->at(0)),
                                                               MAX_SBE_SCRATCH_DATA_WORDS);

        }while(0);

        SBE_TRACD(EXIT_MRK "sendGetScratchDataRequest");
        return errl;
    };

};
